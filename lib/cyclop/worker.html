<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>worker.rb</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div id="jump_to">
    Jump To &hellip;
    <div id="jump_wrapper">
      <div id="jump_page">
          <a class="source" href="../cyclop.html">cyclop.rb</a>
          <a class="source" href="action.html">action.rb</a>
          <a class="source" href="job.html">job.rb</a>
          <a class="source" href="version.html">version.rb</a>
          <a class="source" href="worker.html">worker.rb</a>
      </div>
    </div>
  </div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>worker.rb</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-1">&#182;</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="k">module</span> <span class="nn">Cyclop</span>
  <span class="k">class</span> <span class="nc">Worker</span></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-2">&#182;</a>
        </div>
        <p>Queues to process</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="kp">attr_accessor</span> <span class="ss">:queues</span></pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-3">&#182;</a>
        </div>
        <p>Logger for master</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="kp">attr_accessor</span> <span class="ss">:logger</span></pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-4">&#182;</a>
        </div>
        <p>How much time to sleep between poll</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="kp">attr_accessor</span> <span class="ss">:sleep_interval</span></pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-5">&#182;</a>
        </div>
        <p>Path to actions directory</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="kp">attr_accessor</span> <span class="ss">:actions</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="p">{})</span>
      <span class="k">raise</span> <span class="no">ArgumentError</span><span class="p">,</span> <span class="s1">&#39;mongo[&quot;database&quot;] is required&#39;</span> <span class="k">unless</span> <span class="n">config</span><span class="o">[</span><span class="s2">&quot;mongo&quot;</span><span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="n">config</span><span class="o">[</span><span class="s2">&quot;mongo&quot;</span><span class="o">][</span><span class="s2">&quot;database&quot;</span><span class="o">]</span>

      <span class="nb">self</span><span class="o">.</span><span class="n">queues</span> <span class="o">=</span> <span class="n">config</span><span class="o">[</span><span class="s2">&quot;queues&quot;</span><span class="o">]</span> <span class="o">||</span> <span class="o">[]</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="no">Logger</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">config</span><span class="o">[</span><span class="s2">&quot;log_file&quot;</span><span class="o">]</span> <span class="o">||</span> <span class="vg">$stdout</span><span class="p">)</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">sleep_interval</span> <span class="o">=</span> <span class="n">config</span><span class="o">[</span><span class="s2">&quot;sleep_interval&quot;</span><span class="o">]</span> <span class="o">||</span> <span class="mi">1</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">actions</span> <span class="o">=</span> <span class="n">config</span><span class="o">[</span><span class="s2">&quot;actions&quot;</span><span class="o">]</span> <span class="o">||</span> <span class="s2">&quot;./actions&quot;</span>
      <span class="n">connection</span> <span class="o">=</span> <span class="k">if</span> <span class="n">config</span><span class="o">[</span><span class="s2">&quot;mongo&quot;</span><span class="o">][</span><span class="s2">&quot;hosts&quot;</span><span class="o">]</span>
        <span class="no">Mongo</span><span class="o">::</span><span class="no">ReplSetConnection</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
          <span class="o">*</span><span class="n">config</span><span class="o">[</span><span class="s2">&quot;mongo&quot;</span><span class="o">][</span><span class="s2">&quot;hosts&quot;</span><span class="o">]</span><span class="p">,</span>
          <span class="n">rs_name</span><span class="p">:</span> <span class="n">config</span><span class="o">[</span><span class="s2">&quot;mongo&quot;</span><span class="o">][</span><span class="s2">&quot;rs_name&quot;</span><span class="o">]</span><span class="p">,</span>
          <span class="n">read_secondary</span><span class="p">:</span> <span class="o">!!</span><span class="n">config</span><span class="o">[</span><span class="s2">&quot;mongo&quot;</span><span class="o">][</span><span class="s2">&quot;read_secondary&quot;</span><span class="o">]</span><span class="p">,</span>
          <span class="n">logger</span><span class="p">:</span> <span class="p">(</span><span class="n">logger</span> <span class="k">if</span> <span class="n">config</span><span class="o">[</span><span class="s2">&quot;mongo&quot;</span><span class="o">][</span><span class="s2">&quot;log&quot;</span><span class="o">]</span><span class="p">),</span>
        <span class="p">)</span>
      <span class="k">else</span>
        <span class="no">Mongo</span><span class="o">::</span><span class="no">Connection</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
          <span class="p">(</span><span class="n">config</span><span class="o">[</span><span class="s2">&quot;mongo&quot;</span><span class="o">][</span><span class="s2">&quot;host&quot;</span><span class="o">]</span> <span class="o">||</span> <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">),</span>
          <span class="p">(</span><span class="n">config</span><span class="o">[</span><span class="s2">&quot;mongo&quot;</span><span class="o">][</span><span class="s2">&quot;port&quot;</span><span class="o">]</span> <span class="o">||</span> <span class="mi">27017</span><span class="p">),</span>
          <span class="n">logger</span><span class="p">:</span> <span class="p">(</span><span class="n">logger</span> <span class="k">if</span> <span class="n">config</span><span class="o">[</span><span class="s2">&quot;mongo&quot;</span><span class="o">][</span><span class="s2">&quot;log&quot;</span><span class="o">]</span><span class="p">),</span>
        <span class="p">)</span>
      <span class="k">end</span>
      <span class="no">Cyclop</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">db</span> <span class="n">config</span><span class="o">[</span><span class="s2">&quot;mongo&quot;</span><span class="o">][</span><span class="s2">&quot;database&quot;</span><span class="o">]</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-6">&#182;</a>
        </div>
        <p>Start processing jobs</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">run</span>
      <span class="n">register_signal_handlers</span>
      <span class="kp">loop</span> <span class="k">do</span>
        <span class="k">if</span> <span class="vi">@stop</span>
          <span class="n">log</span> <span class="s2">&quot;Shutting down...&quot;</span>
          <span class="k">break</span>
        <span class="k">end</span>
        <span class="k">if</span> <span class="n">job</span> <span class="o">=</span> <span class="n">next_job</span>
          <span class="vi">@sleeping</span> <span class="o">=</span> <span class="kp">false</span>
          <span class="k">if</span> <span class="vi">@pid</span> <span class="o">=</span> <span class="nb">fork</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Forked process </span><span class="si">#{</span><span class="vi">@pid</span><span class="si">}</span><span class="s2"> to work on job </span><span class="si">#{</span><span class="n">job</span><span class="o">.</span><span class="n">queue</span><span class="si">}</span><span class="s2">-</span><span class="si">#{</span><span class="n">job</span><span class="o">.</span><span class="n">_id</span><span class="si">}</span><span class="s2">...&quot;</span>
            <span class="n">log</span> <span class="n">msg</span>
            <span class="n">procline</span> <span class="n">msg</span>
            <span class="no">Process</span><span class="o">.</span><span class="n">wait</span>
            <span class="n">log</span> <span class="s2">&quot;Child process </span><span class="si">#{</span><span class="vi">@pid</span><span class="si">}</span><span class="s2"> ended with status: </span><span class="si">#{</span><span class="vg">$?</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="vg">$?</span><span class="o">.</span><span class="n">exitstatus</span><span class="o">==</span><span class="mi">0</span>
              <span class="n">job</span><span class="o">.</span><span class="n">complete!</span>
            <span class="k">else</span>
              <span class="n">job</span><span class="o">.</span><span class="n">release!</span>
            <span class="k">end</span>
          <span class="k">else</span>
            <span class="n">procline</span> <span class="s2">&quot;Processing </span><span class="si">#{</span><span class="n">job</span><span class="o">.</span><span class="n">queue</span><span class="si">}</span><span class="s2">-</span><span class="si">#{</span><span class="n">job</span><span class="o">.</span><span class="n">_id</span><span class="si">}</span><span class="s2"> (started at </span><span class="si">#{</span><span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">utc</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="nb">exit!</span> <span class="n">perform</span> <span class="n">job</span>
          <span class="k">end</span>
        <span class="k">else</span>
          <span class="n">log</span> <span class="s2">&quot;No more job to process, start sleeping...&quot;</span> <span class="k">unless</span> <span class="vi">@sleeping</span>
          <span class="vi">@sleeping</span> <span class="o">=</span> <span class="kp">true</span>
          <span class="nb">sleep</span> <span class="n">sleep_interval</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-7">&#182;</a>
        </div>
        <p>Called inside forked process</p>

<p>Parameters:</p>

<ul>
<li>(Cyclop::Job) job &ndash; the job to process</li>
</ul>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">perform</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
      <span class="n">load_actions</span>
      <span class="no">Cyclop</span><span class="o">::</span><span class="no">Action</span><span class="o">.</span><span class="n">find_by_queue</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">queue</span><span class="p">)</span><span class="o">.</span><span class="n">perform</span><span class="p">(</span><span class="o">*</span><span class="n">job</span><span class="o">.</span><span class="n">job_params</span><span class="p">)</span>
      <span class="mi">0</span>
    <span class="k">rescue</span> <span class="no">Exception</span> <span class="o">=&gt;</span> <span class="n">e</span>
      <span class="n">log</span> <span class="n">e</span><span class="o">.</span><span class="n">to_s</span>
      <span class="n">job</span><span class="o">.</span><span class="n">release!</span> <span class="n">e</span>
      <span class="mi">1</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-8">&#182;</a>
        </div>
        <p>Gracefull shutdown</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">stop</span>
      <span class="vi">@stop</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-9'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-9">&#182;</a>
        </div>
        <p>Forced shutdown</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">stop!</span>
      <span class="k">if</span> <span class="vi">@pid</span>
        <span class="no">Process</span><span class="o">.</span><span class="n">kill</span> <span class="s2">&quot;TERM&quot;</span><span class="p">,</span> <span class="vi">@pid</span>
        <span class="no">Process</span><span class="o">.</span><span class="n">wait</span>
      <span class="k">end</span>
      <span class="nb">exit!</span>
    <span class="k">end</span>

  <span class="kp">private</span></pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-10">&#182;</a>
        </div>
        <p>Trap signals</p>

<p>QUIT &ndash; graceful shutdown
INT &ndash; first gracefull shutdown, second time force shutdown
TERM &ndash; force shutdown</p>

      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">register_signal_handlers</span>
      <span class="nb">trap</span><span class="p">(</span><span class="s2">&quot;QUIT&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="n">stop</span> <span class="p">}</span>
      <span class="nb">trap</span><span class="p">(</span><span class="s2">&quot;INT&quot;</span><span class="p">)</span>  <span class="p">{</span> <span class="vi">@stop</span> <span class="p">?</span> <span class="n">stop!</span> <span class="p">:</span> <span class="n">stop</span> <span class="p">}</span>
      <span class="nb">trap</span><span class="p">(</span><span class="s2">&quot;TERM&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="n">stop!</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">next_job</span>
      <span class="no">Cyclop</span><span class="o">.</span><span class="n">next</span> <span class="o">*</span><span class="n">queues</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">procline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
      <span class="vg">$0</span> <span class="o">=</span> <span class="s2">&quot;cyclop-</span><span class="si">#{</span><span class="no">Cyclop</span><span class="o">::</span><span class="no">VERSION</span><span class="si">}</span><span class="s2">: </span><span class="si">#{</span><span class="n">line</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
      <span class="n">logger</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="si">}</span><span class="s2">: </span><span class="si">#{</span><span class="n">message</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">load_actions</span>
      <span class="no">Dir</span><span class="o">[</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">actions</span><span class="si">}</span><span class="s2">/*.rb&quot;</span><span class="o">].</span><span class="n">each</span><span class="p">{</span><span class="o">|</span><span class="n">action</span><span class="o">|</span> <span class="nb">require</span> <span class="n">action</span><span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
